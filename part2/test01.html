<!DOCTYPE html>

<html>

<head>

    <title>TEST of simple GPU/CPU system</title>

</head>

<body>

    <h1>Test01</h1>
    <p>Combining both animation frames into 1.</p>

    <script src="js/gpuv0.js?nocache"></script>
    <script src="js/decls.js?nocache"></script>

    <input type="button" value="Using CPU" onclick="return change(this);" />
    <input type="button" value="Filtering" onclick="return changeFilter(this);" />


    <div id="fps"></div>

    <video hidden id="video" width="800" height="600"></video>
    <canvas hidden id="videoCanvas" width="800" height="600"></canvas>

    <script src="ui.js?nocache"></script>
    <script src="kerneldefsv0.js?nocache"></script>



    <script>

        var canvas, video, width, height, context;
        var copyVideo = false;
        var canvasReady = false;
        var arr = [];
        var imageData;
        var firsttimevid = true;

        function draw() {
            if (copyVideo) {
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                imageData = context.getImageData(0, 0, 800, 600);
                if (firsttimevid === true) {
                    for (var channel = 0; channel < 4; channel++) {
                        arr.push([]);
                        for (var y = 0; y < 600; y++) {
                            arr[channel].push([]);
                        }
                    }
                }
                firsttimevid = false;
                var pointer = 0;
                for (var y = 0; y < 600; y++) {
                    for (var x = 0; x < 800; x++) {
                        arr[0][600 - y - 1][x] = imageData.data[pointer++] / 256;
                        arr[1][600 - y - 1][x] = imageData.data[pointer++] / 256;
                        arr[2][600 - y - 1][x] = imageData.data[pointer++] / 256;
                        arr[3][600 - y - 1][x] = imageData.data[pointer++] / 256;
                    }
                }

                canvasReady = true;
            }
        }

        navigator.getUserMedia = (
            navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia
        );

        function initialize() {
            video = document.getElementById("video");
            width = video.width;
            height = video.height;

            canvas = document.getElementById("videoCanvas");
            context = canvas.getContext('2d');

            video.addEventListener("playing", function () {
                copyVideo = true;
            }, true);

            if (typeof navigator.mediaDevices.getUserMedia === 'undefined') {
                navigator.getUserMedia({ video: true }, streamHandler, errorHandler);
            } else {
                navigator.mediaDevices.getUserMedia({ video: true }).then(streamHandler).catch(errorHandler);
            }
        }

        var myKernelImg = makeImg("gpu");
        var myCodeImg = makeImg("cpu");
        var myKernelFilter2 = makeFilter("gpu");
        var myCodeFilter2 = makeFilter("cpu");
        var orig;
        var afterload = false;
        var animIndex = 0;
        var canvas = myKernelImg.getCanvas();
        document.getElementsByTagName('body')[0].appendChild(canvas);

        var f = document.querySelector("#fps");
        function renderLoop() {
            f.innerHTML = fps.getFPS();
            draw();
            if (canvasReady === true) {
                if (selection === 0) {
                    orig = myKernelImg(arr);
                    afterload = true;
                    var C = orig;
                    if (filtering === 0) {
                        var X = myCodeFilter2(C);
                    } else {
                        var X = C;
                    }
                } else {
                    orig = myKernelImg(arr);
                    afterload = true;
                    var C = orig;
                    if (filtering === 0) {
                        var X = myKernelFilter2(C);
                    } else {
                        var X = C;
                    }
                }
                var E = toimg(X);
            } else {
                console.log("video not ready yet");
            }

            //      setTimeout(renderLoop,1);            // Uncomment this line, and comment the next line
            requestAnimationFrame(renderLoop);     // to see how fast this could run...
        }

        window.onload = renderLoop;

        function streamHandler(stream) {
            video.src = URL.createObjectURL(stream);
            video.play();
        }


        addEventListener("DOMContentLoaded", initialize);

    </script>

</body>

</html>
